<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ssgrid">
<title>2. Set-up a job array to run on OSG • ssgrid</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Set-up a job array to run on OSG">
<meta property="og:description" content="ssgrid">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ssgrid</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/a_setup_osg.html">1. Set-up OSG to work with ssgrid</a>
    <a class="dropdown-item" href="../articles/b_model_ensemble.html">2. Set-up a job array to run on OSG</a>
    <a class="dropdown-item" href="../articles/c_run_diags.html">3. Run diagnostics for a Stock Synthesis model using OSG</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/N-DucharmeBarth-NOAA/ssgrid/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>2. Set-up a job array to run on OSG</h1>
                        <h4 data-toc-skip class="author">Nicholas Ducharme-Barth</h4>
            
            <h4 data-toc-skip class="date">2022-10-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/N-DucharmeBarth-NOAA/ssgrid/blob/HEAD/vignettes/b_model_ensemble.Rmd" class="external-link"><code>vignettes/b_model_ensemble.Rmd</code></a></small>
      <div class="d-none name"><code>b_model_ensemble.Rmd</code></div>
    </div>

    
    
<p>In this example we will set up and run a simple job array of Stock Synthesis models on OSG and show how results can be combined in a model ensemble. We assume that you have already set-up your OSG environment to work with <em>ssgrid</em>. If not, please check out <a href="https://n-ducharmebarth-noaa.github.io/ssgrid/articles/a_setup_osg.html">this guide</a>. Here we use example Stock Synthesis input files<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Simulated data loosely based on Pacific Hake.&lt;/p&gt;"><sup>1</sup></a> that are distributed with <em>ssgrid</em> but these can be substituted for any Stock Synthesis files read in using <a href="https://github.com/r4ss/r4ss" class="external-link"><em>r4ss</em></a>.</p>
<p>The first step is to load <em>ssgrid</em>. We will also use both <a href="https://github.com/r4ss/r4ss" class="external-link"><em>r4ss</em></a> and <a href="https://github.com/PIFSCstockassessments/ss3diags" class="external-link"><em>ss3diags</em></a> but will reference those functions directly.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/N-DucharmeBarth-NOAA/ssgrid" class="external-link">ssgrid</a></span><span class="op">)</span></span></code></pre></div>
<p>The Stock Synthesis input files:</p>
<ul>
<li><code>ss_control</code></li>
<li><code>ss_data</code></li>
<li><code>ss_starter</code></li>
<li><code>ss_forecast</code></li>
</ul>
<p>are automatically available upon loading the <em>ssgrid</em> package.</p>
<p>We also need to define the directory where we are going to build the files needed to run our job array.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">array_directory</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,<span class="st">"/example/ensemble/"</span><span class="op">)</span></span>
<span>  <span class="co"># check if directory exists, otherwise create it</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">array_directory</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">array_directory</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>Here I create a directory within my default working directory but you can change/name this to anything you want. This is where the Stock Synthesis files will get written into, and where results from OSG will get downloaded.</p>
<p>The next step is set up the different model configurations to investigate as a part of our model ensemble or job array. In this simple example, we are assume that natural mortality (<em>M</em>) and steepness (<em>h</em>) are fixed but there is uncertainty regarding the assumed values. Let us consider three alternative hypotheses for each value and a full-factorial ensemble of possible combinations:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">testing_options</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>M<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span><span class="op">)</span>,</span>
<span>                                h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.75</span>,<span class="fl">0.85</span>,<span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we can write the Stock Synthesis files into sub-directories of <code>array_directory</code>, making sure to modify the control file to have the appropriate settings for <em>M</em> and <em>h</em>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">testing_options</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="co"># create sub-directory</span></span>
<span>      <span class="va">tmp_name</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">testing_options</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,collapse <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>      <span class="va">tmp_dir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">array_directory</span>,<span class="va">tmp_name</span>,<span class="st">"/"</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">tmp_dir</span>,recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="co"># modify input file - M</span></span>
<span>      <span class="va">tmp_ctl</span> <span class="op">=</span> <span class="va">ss_control</span></span>
<span>      <span class="va">pointer</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"NatM_p_1_Fem_GP_1"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">tmp_ctl</span><span class="op">$</span><span class="va">MG_parms</span><span class="op">)</span>,fixed<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">tmp_M</span> <span class="op">=</span> <span class="va">testing_options</span><span class="op">$</span><span class="va">M</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>            <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">MG_parms</span><span class="op">$</span><span class="va">LO</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span> <span class="op">=</span> <span class="va">tmp_M</span> <span class="op">-</span> <span class="fl">0.1</span><span class="op">*</span><span class="va">tmp_M</span></span>
<span>            <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">MG_parms</span><span class="op">$</span><span class="va">HI</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span> <span class="op">=</span> <span class="va">tmp_M</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">*</span><span class="va">tmp_M</span></span>
<span>            <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">MG_parms</span><span class="op">$</span><span class="va">INIT</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span> <span class="op">=</span> <span class="va">tmp_M</span></span>
<span>            <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">MG_parms</span><span class="op">$</span><span class="va">PRIOR</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span> <span class="op">=</span> <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">MG_parms</span><span class="op">$</span><span class="va">INIT</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span></span>
<span>    <span class="co"># modify input file - h</span></span>
<span>        <span class="va">pointer</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"SR_BH_flat_steep"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">tmp_ctl</span><span class="op">$</span><span class="va">SR_parms</span><span class="op">)</span>,fixed<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>            <span class="va">tmp_h</span> <span class="op">=</span> <span class="va">testing_options</span><span class="op">$</span><span class="va">h</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>            <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">SR_parms</span><span class="op">$</span><span class="va">LO</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.2</span></span>
<span>            <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">SR_parms</span><span class="op">$</span><span class="va">HI</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.999</span></span>
<span>            <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">SR_parms</span><span class="op">$</span><span class="va">INIT</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span> <span class="op">=</span> <span class="va">tmp_h</span></span>
<span>            <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">SR_parms</span><span class="op">$</span><span class="va">PRIOR</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span> <span class="op">=</span> <span class="va">tmp_ctl</span><span class="op">$</span><span class="va">SR_parms</span><span class="op">$</span><span class="va">INIT</span><span class="op">[</span><span class="va">pointer</span><span class="op">]</span></span>
<span>    <span class="co"># write input files</span></span>
<span>      <span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SS_writectl.html" class="external-link">SS_writectl</a></span><span class="op">(</span>ctllist <span class="op">=</span> <span class="va">tmp_ctl</span>, outfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmp_dir</span>,<span class="st">"control.ss"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SS_writedat.html" class="external-link">SS_writedat</a></span><span class="op">(</span>datlist <span class="op">=</span> <span class="va">ss_data</span>, outfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmp_dir</span>,<span class="st">"data.ss"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SS_writeforecast.html" class="external-link">SS_writeforecast</a></span><span class="op">(</span>mylist <span class="op">=</span> <span class="va">ss_forecast</span>, dir <span class="op">=</span> <span class="va">tmp_dir</span><span class="op">)</span></span>
<span>      <span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SS_writestarter.html" class="external-link">SS_writestarter</a></span><span class="op">(</span>mylist <span class="op">=</span> <span class="va">ss_starter</span>, dir <span class="op">=</span> <span class="va">tmp_dir</span><span class="op">)</span></span>
<span>    <span class="co"># clean-up</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tmp_name"</span>,<span class="st">"tmp_dir"</span>,<span class="st">"tmp_ctl"</span>,<span class="st">"pointer"</span>,<span class="st">"tmp_M"</span>,<span class="st">"tmp_h"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
<p>Now that all the input files are created we can upload the directories to OSG, set up the job array, and run the job! When modifying this code for your purposes, make sure to request enough memory and disk space in <code><a href="../reference/osg_condor_submit_create.html">osg_condor_submit_create()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># open a connection to OSG via ssh</span></span>
<span>    <span class="va">osg_session</span> <span class="op">=</span> <span class="fu"><a href="../reference/osg_connect.html">osg_connect</a></span><span class="op">(</span>unix_name <span class="op">=</span> <span class="st">"your.username"</span>, login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># upload the directory</span></span>
<span>      <span class="fu"><a href="../reference/osg_upload_ss_dir.html">osg_upload_ss_dir</a></span><span class="op">(</span>session <span class="op">=</span> <span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    local_dir_path <span class="op">=</span> <span class="va">array_directory</span>,</span>
<span>                    local_dir_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">array_directory</span>,full.names<span class="op">=</span><span class="cn">FALSE</span>,recursive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>                    remote_dir_path <span class="op">=</span> <span class="st">"example/ensemble/"</span>,</span>
<span>                    files_to_upload <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"control.ss"</span>,<span class="st">"data.ss"</span>,<span class="st">"forecast.ss"</span>,<span class="st">"starter.ss"</span><span class="op">)</span>,</span>
<span>                    target_dir_path <span class="op">=</span> <span class="st">"target_dir_files/"</span>,</span>
<span>                    target_dir_txt_name <span class="op">=</span> <span class="st">"target_dir.txt"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># define job executable to run a Stock Synthesis model for each model defined by testing_options</span></span>
<span>      <span class="fu"><a href="../reference/osg_wrapper_create.html">osg_wrapper_create</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    wrapper_actions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"00_run_ss"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># create condor_submit script</span></span>
<span>      <span class="fu"><a href="../reference/osg_condor_submit_create.html">osg_condor_submit_create</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    c_memory<span class="op">=</span><span class="st">"600MB"</span>,</span>
<span>                    c_disk<span class="op">=</span><span class="st">"600MB"</span>,</span>
<span>                    c_input_files<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Start.tar.gz"</span>,<span class="st">"ss_linux"</span><span class="op">)</span>,</span>
<span>                    c_project<span class="op">=</span><span class="st">"osg.your_project"</span>,</span>
<span>                    c_target_dir_path<span class="op">=</span><span class="st">"target_dir_files/target_dir.txt"</span>,</span>
<span>                    c_singularity<span class="op">=</span><span class="st">"r:4.0.2"</span>,</span>
<span>                    overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># copy Stock Synthesis executable into each directory on OSG</span></span>
<span>      <span class="fu"><a href="../reference/osg_multi_copy.html">osg_multi_copy</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    remote_source_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ss_executable/3.30.16.00_safe/"</span><span class="op">)</span>,</span>
<span>                    files_to_copy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ss_linux"</span><span class="op">)</span>,</span>
<span>                    remote_paste_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"example/ensemble/"</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">array_directory</span>,full.names<span class="op">=</span><span class="cn">FALSE</span>,recursive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,<span class="st">"/"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># launch the job!</span></span>
<span>      <span class="fu"><a href="../reference/osg_execute.html">osg_execute</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span><span class="op">)</span></span></code></pre></div>
<p>Success! All nine models will now be run simultaneously using OSG’s HTcondor high-throughput computing network. It may take a minute or so (depending on the requirements listed in <code><a href="../reference/osg_condor_submit_create.html">osg_condor_submit_create()</a></code>) for your jobs to make it to the front of the queue. However, all jobs should be finished running in a few minutes since this example uses a simple model. You can monitor the status of your job using <code><a href="../reference/osg_monitor.html">osg_monitor()</a></code> which is just a wrapper around <a href="https://htcondor.readthedocs.io/en/latest/man-pages/condor_q.html" class="external-link">condor_q</a> if you are directly logged into OSG via the terminal.</p>
<p>Once the jobs finish running, you can go ahead and download the results using <code>osg_download()</code>, and then close the connection to OSG. Here we will download the model results, compressed as <code>End.tar.gz</code>. We will also specify that we want to un-tar the results after downloading.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="fu"><a href="../reference/osg_download_ss_dir.html">osg_download_ss_dir</a></span><span class="op">(</span>session <span class="op">=</span> <span class="va">osg_session</span>,</span>
<span>              unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    remote_dir_stem<span class="op">=</span><span class="st">"example/ensemble/"</span>,</span>
<span>                    remote_dirs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">array_directory</span>,full.names<span class="op">=</span><span class="cn">FALSE</span>,recursive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>                    download_dir_stem<span class="op">=</span><span class="va">array_directory</span>,</span>
<span>                    files_to_download<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"End.tar.gz"</span><span class="op">)</span>,</span>
<span>                    untar_local<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                    clean_remote<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                    delete_remote<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                    verbose<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">ssh</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/ssh/reference/ssh.html" class="external-link">ssh_disconnect</a></span><span class="op">(</span><span class="va">osg_session</span><span class="op">)</span></span></code></pre></div>
<p>Now that our models our downloaded, we can use existing functionality in the <a href="https://github.com/r4ss/r4ss" class="external-link"><em>r4ss</em></a> and <a href="https://github.com/PIFSCstockassessments/ss3diags" class="external-link"><em>ss3diags</em></a> packages to extract the results and combine them to form a model ensemble.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># get the results</span></span>
<span>    <span class="va">tmp_models</span> <span class="op">=</span> <span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/SSgetoutput.html" class="external-link">SSgetoutput</a></span><span class="op">(</span>dirvec<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">array_directory</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">array_directory</span>,full.names<span class="op">=</span><span class="cn">FALSE</span>,recursive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,<span class="st">"/"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmp_models</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">array_directory</span>,full.names<span class="op">=</span><span class="cn">FALSE</span>,recursive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># use ss3diags::SSdeltaMVLN() to generate uncertainty using the estimated variance-covariance matrix in a Monte Carlo simulation</span></span>
<span>  <span class="co"># We generate 10,000 samples per model and assume each has equal weight in the ensemble.</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>    <span class="va">mvn_samples.list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tmp_models</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">tmp_models</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">mvn_samples.list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu">SSdeltaMVLN</span><span class="op">(</span><span class="va">tmp_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,mc<span class="op">=</span><span class="fl">10000</span>,weight <span class="op">=</span> <span class="fl">1</span>, run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tmp_models</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">kb</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># combine samples across models</span></span>
<span>    <span class="va">mvn_samples</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">mvn_samples.list</span><span class="op">)</span></span></code></pre></div>
<p>Plot the individual model results.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">array_directory</span>,<span class="st">"MVLN_Trjs.png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span> <span class="fl">9</span>, res <span class="op">=</span> <span class="fl">300</span>, units <span class="op">=</span> <span class="st">"in"</span><span class="op">)</span></span>
<span>      <span class="fu">r4ss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/r4ss/man/sspar.html" class="external-link">sspar</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span>,plot.cex <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>      <span class="fu">ss3diags</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ss3diags/man/SSplotEnsemble.html" class="external-link">SSplotEnsemble</a></span><span class="op">(</span><span class="va">mvn_samples</span>, add <span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="MVLN_Trjs.png" id="id" class="class" style="width:50.0%;height:50.0%"></p>
<p>Plot the combined ensemble results.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">array_directory</span>, <span class="st">"/kobe_kernel"</span>,<span class="st">".png"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">9</span>, height <span class="op">=</span> <span class="fl">9</span>, res <span class="op">=</span> <span class="fl">300</span>, units <span class="op">=</span> <span class="st">"in"</span><span class="op">)</span></span>
<span>      <span class="fu">ss3diags</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ss3diags/man/SSplotKobe.html" class="external-link">SSplotKobe</a></span><span class="op">(</span><span class="va">mvn_samples</span>,posterior <span class="op">=</span> <span class="st">"kernel"</span><span class="op">)</span> <span class="co"># show CIs with 2d-Kernel</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="kobe_kernel.png" id="id" class="class" style="width:50.0%;height:50.0%"></p>
<p>Additionally, as a part of the job executable defined by <code><a href="../reference/osg_wrapper_create.html">osg_wrapper_create()</a></code>, all jobs get returned with a text file <code>runtime.txt</code>. This gives the actual execution time of the job in seconds, excluding file transfer and waiting in the queue. We can extract this value for each model and sum across models to see how long it actually took to run our nine example models on OSG.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">runtime_vec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">testing_options</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">runtime_vec</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">runtime_vec</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scan.html" class="external-link">scan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">array_directory</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.dirs</a></span><span class="op">(</span><span class="va">array_directory</span>,full.names<span class="op">=</span><span class="cn">FALSE</span>,recursive<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"/runtime.txt"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">avg_runtime_m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">runtime_vec</span><span class="op">)</span><span class="op">/</span><span class="fl">60</span></span>
<span>  <span class="va">total_runtime_m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">runtime_vec</span><span class="op">)</span><span class="op">/</span><span class="fl">60</span></span></code></pre></div>
<p>In this simple example each model took just over a minute to run, with a little over nine minutes of total runtime.</p>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Nicholas Ducharme-Barth.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
