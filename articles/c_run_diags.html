<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ssgrid">
<title>3. Run diagnostics for a Stock Synthesis model using OSG â€¢ ssgrid</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="3. Run diagnostics for a Stock Synthesis model using OSG">
<meta property="og:description" content="ssgrid">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ssgrid</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/a_setup_osg.html">1. Set-up OSG to work with ssgrid</a>
    <a class="dropdown-item" href="../articles/b_model_ensemble.html">2. Set-up a job array to run on OSG</a>
    <a class="dropdown-item" href="../articles/c_run_diags.html">3. Run diagnostics for a Stock Synthesis model using OSG</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/N-DucharmeBarth-NOAA/ssgrid/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>3. Run diagnostics for a Stock Synthesis model using OSG</h1>
                        <h4 data-toc-skip class="author">Nicholas Ducharme-Barth</h4>
            
            <h4 data-toc-skip class="date">2022-10-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/N-DucharmeBarth-NOAA/ssgrid/blob/HEAD/vignettes/c_run_diags.Rmd" class="external-link"><code>vignettes/c_run_diags.Rmd</code></a></small>
      <div class="d-none name"><code>c_run_diags.Rmd</code></div>
    </div>

    
    
<p>This article describes how to run advanced Stock Synthesis diagnostics on OSG using the <em>ssgrid</em> package. The workflow is very similar to what was described in the article on <a href="https://n-ducharmebarth-noaa.github.io/ssgrid/articles/b_model_ensemble.html">setting up a job array</a>. Here I will describe the process for running diagnostics for a single model that has already been run locally. However, I will also describe how this process can be generalized to run diagnostics for multiple models and for those that have not been run locally.</p>
<p>As before, the first step is to open a connection to OSG.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># open a connection to OSG via ssh</span></span>
<span>    <span class="va">osg_session</span> <span class="op">=</span> <span class="fu"><a href="../reference/osg_connect.html">osg_connect</a></span><span class="op">(</span>unix_name <span class="op">=</span> <span class="st">"your.username"</span>, login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span><span class="op">)</span></span></code></pre></div>
<p>Next, upload your files. If uploading models where Stock Synthesis has already been run locally, you will want to include the <code>ss.par</code> file if you plan to run an R0 likelihood profile. Otherwise, if you plan to run the Stock Synthesis model on OSG, just upload the necessary Stock Synthesis input files. If you want to run diagnostics for more than one model, just modify <code>local_dir_names</code> to include all the sub-directories for all of the models you want to run diagnostics for. Currently, in order to run more than one model simultaneously they all have to be sub-directories within the same directory defined by <code>local_dir_path</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># upload the directory</span></span>
<span>      <span class="fu"><a href="../reference/osg_upload_ss_dir.html">osg_upload_ss_dir</a></span><span class="op">(</span>session <span class="op">=</span> <span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    local_dir_path <span class="op">=</span> <span class="st">"path_to_local_directory/"</span>,</span>
<span>                    local_dir_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"path_to_local_subdir/"</span><span class="op">)</span>,</span>
<span>                    remote_dir_path <span class="op">=</span> <span class="st">"remote_dir_path/"</span>,</span>
<span>                    files_to_upload <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"control.ss"</span>,<span class="st">"data.ss"</span>,<span class="st">"forecast.ss"</span>,<span class="st">"starter.ss"</span>,<span class="st">"ss.par"</span><span class="op">)</span>,</span>
<span>                    target_dir_path <span class="op">=</span> <span class="st">"target_dir_files/"</span>,</span>
<span>                    target_dir_txt_name <span class="op">=</span> <span class="st">"target_dir.txt"</span><span class="op">)</span></span></code></pre></div>
<p>Now, create the job executable. In the <a href="https://n-ducharmebarth-noaa.github.io/ssgrid/articles/b_model_ensemble.html">previous example</a> the only <code>wrapper_actions</code> that was defined was <code>"00_run_ss"</code>. This was because we wanted to run a Stock Synthesis model on OSG. You should leave that defined as the first entry to <code>wrapper_actions</code> if you plan to run Stock Synthesis on OSG. In this case we will remove it since we are already starting from a model that has been run locally. Additionally, if you do not want to run all diagnostics, you do not have to define all of them in <code>wrapper_actions</code>. You can run a single diagnostic or any combination of the three diagnostics that are currently defined. In this case we will run all three diagnostic types defined:</p>
<ul>
<li>
<code>"01_run_retro</code>: retrospective</li>
<li>
<code>"02_run_R0profile"</code>: R0 likelihood profile</li>
<li>
<code>"03_run_aspm"</code>: production model type diagnostics
<ul>
<li>age-structured production model (ASPM)</li>
<li>deterministic recruitment model</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># upload the directory</span></span>
<span>    <span class="fu"><a href="../reference/osg_wrapper_create.html">osg_wrapper_create</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    wrapper_actions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"01_run_retro"</span>,<span class="st">"02_run_R0profile"</span>,<span class="st">"03_run_aspm"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Having specified which diagnostics we would like to run, we need to define the R scripts to call the <a href="https://github.com/r4ss/r4ss" class="external-link"><em>r4ss</em></a> functions needed to run them. At this stage <code><a href="../reference/osg_r_create.html">osg_r_create()</a></code> is not vectorized and has to be called for each diagnostic.</p>
<blockquote>
<p><strong><em>Note:</em></strong> You can specifiy the number of years for your retrospective analysis and the resolution of the R0 profile.</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="fu"><a href="../reference/osg_r_create.html">osg_r_create</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    diagnostic_type <span class="op">=</span> <span class="st">"01_run_retro"</span>,</span>
<span>                    retro_n_years <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="../reference/osg_r_create.html">osg_r_create</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    diagnostic_type <span class="op">=</span> <span class="st">"02_run_R0profile"</span>,</span>
<span>                    r0_maxdiff <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                    r0_step <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="../reference/osg_r_create.html">osg_r_create</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    diagnostic_type <span class="op">=</span> <span class="st">"03_run_aspm"</span><span class="op">)</span></span></code></pre></div>
<p>The submit script needs to include a list of all input files that need to be sent with each condor job. Since we are using R we need to send the portable R distribution <code>"R-packages.tar.gz"</code> <a href="https://n-ducharmebarth-noaa.github.io/ssgrid/articles/a_setup_osg.html">that was previously created</a>, along with the three R scripts that were just created with <code><a href="../reference/osg_r_create.html">osg_r_create()</a></code>. We also request a little more disk space (<code>"850MB"</code>) since we need to store the results from multiple diagnostic runs.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>      <span class="fu"><a href="../reference/osg_condor_submit_create.html">osg_condor_submit_create</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    c_memory<span class="op">=</span><span class="st">"600MB"</span>,</span>
<span>                    c_disk<span class="op">=</span><span class="st">"850MB"</span>,</span>
<span>                    c_input_files<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Start.tar.gz"</span>,<span class="st">"ss_linux"</span>,<span class="st">"R-packages.tar.gz"</span>,<span class="st">"01_run_retro.r"</span>,<span class="st">"02_run_R0profile.r"</span>,<span class="st">"03_run_aspm.r"</span><span class="op">)</span>,</span>
<span>                    c_project<span class="op">=</span><span class="st">"osg.your_project"</span>,</span>
<span>                    c_target_dir_path<span class="op">=</span><span class="st">"target_dir_files/target_dir.txt"</span>,</span>
<span>                    c_singularity<span class="op">=</span><span class="st">"r:4.0.2"</span>,</span>
<span>                    overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>All input files listed in <code><a href="../reference/osg_condor_submit_create.html">osg_condor_submit_create()</a></code> must be copied to each directory you plan on running a condor job in. If you plan on running diagnostics for multiple models, make sure the <code>remote_paste_path</code> contains all directories created by <code><a href="../reference/osg_upload_ss_dir.html">osg_upload_ss_dir()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>      <span class="fu"><a href="../reference/osg_multi_copy.html">osg_multi_copy</a></span><span class="op">(</span>session<span class="op">=</span><span class="va">osg_session</span>,</span>
<span>                    unix_name <span class="op">=</span> <span class="st">"your.username"</span>,</span>
<span>                    login_node <span class="op">=</span> <span class="st">"login05.osgconnect.net"</span>,</span>
<span>                    remote_source_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R-lib-4.0.2/"</span>,<span class="st">"ss_executable/3.30.16.00_safe/"</span>,<span class="st">"scripts/r/"</span>,<span class="st">"scripts/r/"</span>,<span class="st">"scripts/r/"</span><span class="op">)</span>,</span>
<span>                    files_to_copy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R-packages.tar.gz"</span>,<span class="st">"ss_linux"</span>,<span class="st">"01_run_retro.r"</span>,<span class="st">"02_run_R0profile.r"</span>,<span class="st">"03_run_aspm.r"</span><span class="op">)</span>,</span>
<span>                    remote_paste_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"remote_dir_path/"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"path_to_local_subdir/"</span><span class="op">)</span>,<span class="st">"/"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now you can launch and download the jobs <a href="https://n-ducharmebarth-noaa.github.io/ssgrid/articles/b_model_ensemble.html">as before</a> using <code><a href="../reference/osg_execute.html">osg_execute()</a></code> and <code><a href="../reference/osg_download_ss_dir.html">osg_download_ss_dir()</a></code>. Total runtime of each job will depend on the time it takes for the Stock Synthesis model to converge, the number of retrospective years, and the resolution of the R0 likelihood profile.</p>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Nicholas Ducharme-Barth.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
